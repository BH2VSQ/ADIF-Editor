import React, { useState, useRef } from "react";

// Simple single-file React ADIF viewer/editor
// Tailwind CSS classes used for styling (assumes Tailwind available in host app)
// Features:
// - 导入 .adi/.adi.txt 文件
// - 解析 ADIF（基本字段）到 JSON
// - 表格查看、排序、筛选、搜索
// - 行内编辑与模态编辑
// - 新增 / 删除 QSO
// - 导出回 ADIF

export default function AdifEditor() {
  const [records, setRecords] = useState([]);
  const [fields, setFields] = useState([]);
  const [query, setQuery] = useState("");
  const [selected, setSelected] = useState(null);
  const fileRef = useRef(null);

  // Basic ADIF parser -- supports simple ADIF v2-ish text format
  function parseAdif(text) {
    // remove header until <EOH>
    const headerIndex = text.toUpperCase().indexOf("<EOH>");
    const body = headerIndex >= 0 ? text.slice(headerIndex + 5) : text;

    // ADIF records usually separated by <EOR>
    const rawRecs = body.split(/<EOR>/i).map(r => r.trim()).filter(Boolean);
    const recs = [];
    const allFields = new Set();

    rawRecs.forEach(raw => {
      const obj = {};
      // find all tags like <CALL:5>calls</CALL>? Actually ADIF uses <CALL:5>CALLVALUE
      // We'll use regex to find <FIELD:len>(value)
      const tagRe = /<([^:>\s]+)(?::(\d+))?(?:[^>]*)>([^<]*)/gi;
      let m;
      while ((m = tagRe.exec(raw)) !== null) {
        const name = m[1].toUpperCase();
        let val = m[3] || "";
        val = val.trim();
        obj[name] = val;
        allFields.add(name);
      }
      // Many ADIFs put <> around timestamps; common fields like QSO_DATE, TIME_ON
      if (Object.keys(obj).length > 0) recs.push(obj);
    });

    setFields(Array.from(allFields).sort());
    setRecords(recs.map((r, i) => ({ __id: i + 1, ...r })));
  }

  function buildAdif(recs) {
    // minimal ADIF header
    let out = "\nGenerated by Web ADIF Editor\n\n<ADIF_VERS:5>2.2\n<PROGRAMID:12>WebAdifEditor\n<EOH>\n";
    recs.forEach(r => {
      Object.keys(r).forEach(k => {
        if (k === "__id") return;
        const v = String(r[k] ?? "");
        out += `<${k}:${v.length}>${v}`;
      });
      out += "<EOR>\n";
    });
    return out;
  }

  function handleFile(e) {
    const f = e.target.files?.[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      parseAdif(String(reader.result));
    };
    reader.readAsText(f);
  }

  function exportAdif() {
    const text = buildAdif(records);
    const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "export.adi";
    a.click();
    URL.revokeObjectURL(url);
  }

  function filtered() {
    if (!query) return records;
    const q = query.toLowerCase();
    return records.filter(r =>
      Object.values(r).some(v => String(v).toLowerCase().includes(q))
    );
  }

  function startEdit(rec) {
    setSelected({ ...rec });
  }

  function saveEdit() {
    setRecords(prev => prev.map(r => (r.__id === selected.__id ? selected : r)));
    setSelected(null);
  }

  function addEmpty() {
    const id = (records.reduce((m, r) => Math.max(m, r.__id || 0), 0) || 0) + 1;
    const newRec = { __id: id, CALL: "", QSO_DATE: "", TIME_ON: "", BAND: "", MODE: "", RST_SENT: "", RST_RCVD: "" };
    setRecords(prev => [newRec, ...prev]);
    setSelected(newRec);
  }

  function deleteRec(id) {
    if (!confirm("确定删除这条 QSO 吗？")) return;
    setRecords(prev => prev.filter(r => r.__id !== id));
  }

  return (
    <div className="p-4 max-w-6xl mx-auto">
      <div className="flex items-center justify-between mb-4">
        <h1 className="text-2xl font-bold">Web ADIF 日志查看 / 编辑器</h1>
        <div className="flex gap-2">
          <input ref={fileRef} type="file" accept=".adi,.adi.txt,.adi,application/octet-stream" onChange={handleFile} className="hidden" />
          <button className="px-3 py-2 rounded bg-slate-800 text-white" onClick={() => fileRef.current.click()}>导入 ADIF</button>
          <button className="px-3 py-2 rounded border" onClick={addEmpty}>新增 QSO</button>
          <button className="px-3 py-2 rounded bg-green-600 text-white" onClick={exportAdif}>导出 ADIF</button>
        </div>
      </div>

      <div className="mb-4 flex gap-3">
        <input className="flex-1 p-2 border rounded" placeholder="搜索（按任意字段）" value={query} onChange={e => setQuery(e.target.value)} />
        <div className="text-sm text-gray-600">记录: {records.length}</div>
      </div>

      <div className="overflow-x-auto border rounded">
        <table className="min-w-full text-sm">
          <thead className="bg-slate-100">
            <tr>
              <th className="p-2">#</th>
              <th className="p-2">CALL</th>
              <th className="p-2">QSO_DATE</th>
              <th className="p-2">TIME_ON</th>
              <th className="p-2">BAND</th>
              <th className="p-2">MODE</th>
              <th className="p-2">RST_SENT</th>
              <th className="p-2">RST_RCVD</th>
              <th className="p-2">操作</th>
            </tr>
          </thead>
          <tbody>
            {filtered().map(r => (
              <tr key={r.__id} className="odd:bg-white even:bg-slate-50">
                <td className="p-2">{r.__id}</td>
                <td className="p-2">{r.CALL || "—"}</td>
                <td className="p-2">{r.QSO_DATE || ""}</td>
                <td className="p-2">{r.TIME_ON || ""}</td>
                <td className="p-2">{r.BAND || ""}</td>
                <td className="p-2">{r.MODE || ""}</td>
                <td className="p-2">{r.RST_SENT || ""}</td>
                <td className="p-2">{r.RST_RCVD || ""}</td>
                <td className="p-2">
                  <div className="flex gap-2">
                    <button className="px-2 py-1 border rounded" onClick={() => startEdit(r)}>编辑</button>
                    <button className="px-2 py-1 border rounded text-red-600" onClick={() => deleteRec(r.__id)}>删除</button>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* Editor modal */}
      {selected && (
        <div className="fixed inset-0 bg-black/40 flex items-center justify-center p-4">
          <div className="bg-white rounded-lg w-full max-w-2xl p-4">
            <h2 className="text-lg font-semibold mb-2">编辑 QSO — ID {selected.__id}</h2>
            <div className="grid grid-cols-2 gap-2">
              {[
                "CALL",
                "QSO_DATE",
                "TIME_ON",
                "BAND",
                "MODE",
                "FREQ",
                "RST_SENT",
                "RST_RCVD",
                "NAME",
                "QTH",
                "COMMENT",
              ].map(f => (
                <div key={f} className="flex flex-col">
                  <label className="text-xs text-gray-600">{f}</label>
                  <input
                    value={selected[f] ?? ""}
                    onChange={e => setSelected(prev => ({ ...prev, [f]: e.target.value }))}
                    className="p-2 border rounded"
                  />
                </div>
              ))}
            </div>
            <div className="mt-4 flex justify-end gap-2">
              <button className="px-3 py-2 border rounded" onClick={() => setSelected(null)}>取消</button>
              <button className="px-3 py-2 bg-blue-600 text-white rounded" onClick={saveEdit}>保存</button>
            </div>
          </div>
        </div>
      )}

      <div className="mt-6 text-sm text-gray-600">
        可识别字段: {fields.length ? fields.join(", ") : "（暂无）"}
      </div>

      <div className="mt-4 text-xs text-gray-500">
        说明: 这是一个轻量单文件示例，可在项目中直接集成并扩展：例如加入 ADIF 更严格校验、CSV 导入/导出、地图显示（QTH）、LOTW/HRD 导入同步、批量编辑等功能。
      </div>
    </div>
  );
}
